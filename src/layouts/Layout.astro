---
import { siteConfig } from '@/config';
import "@styles/global.css"
import 'katex/dist/katex.min.css';
import { i18n } from "astro:config/client";
import { ClientRouter } from "astro:transitions";

interface Props {
  title: string;
  lang?: string;
}
const { title, lang } = Astro.props;

const pageTitle = title;
const pageLang = lang || i18n?.defaultLocale || "zh-cn";
---

<!DOCTYPE html>
<html lang={pageLang} class="h-full">
<head>
    <script is:inline>
        (function() {
        const savedTheme = localStorage.getItem('theme');
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        const theme = savedTheme || systemTheme;
        document.documentElement.setAttribute('data-theme', theme);
        
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="alternate" type="application/rss+xml" title={siteConfig.title} href={new URL("rss.xml", Astro.site)} >
    <link rel="icon" href={siteConfig.favicon} type="image/x-icon">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond">
    <title>{pageTitle}</title>
    <ClientRouter />
</head>
<body class="h-full bg-[var(--bg-color)]">
    
    <div id="loading-overlay" aria-hidden="true">
      <div class="spinner"></div>
    </div>

    <slot />
    
    <script is:inline>
        let loaderTimeout;

        // 1. 开始准备跳转
        document.addEventListener('astro:before-preparation', () => {
            // 只有当加载超过 500ms 时才显示动画 (你可以根据需要调成 300ms 或 1s)
            loaderTimeout = setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'flex';
            }, 500); 
        });

        // 2. 页面内容交换完成（DOM 已更新）
        document.addEventListener('astro:after-swap', () => {
            // 如果页面加载很快，在 500ms 内就完成了，这里会清除计时器，动画根本不会显示
            clearTimeout(loaderTimeout);
            
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'none';
        });

        // 3. 兜底方案：页面完全加载完成（包括资源）
        document.addEventListener('astro:page-load', () => {
            clearTimeout(loaderTimeout);
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'none';
        });
        </script>
</body>
</html>

<style is:global>
  /* 加载动画的遮罩层 */
  #loading-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.7);
    z-index: 9999;
    backdrop-filter: blur(2px);
    /* 添加一个简单的淡入过渡 */
    animation: fadeIn 0.3s ease-out;
  }

  [data-theme="dark"] #loading-overlay {
    background-color: rgba(0, 0, 0, 0.7);
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* 旋转图标样式 */
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--button-hover-color);
    border-top: 4px solid var(--link-color); /* 进度颜色 */
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<style is:global>
  /* 1. 容器必须是相对定位，以便定位按钮 */
  pre {
    position: relative !important;
  }

  .copy-btn {
    position: absolute;
    top: 12px;
    right: 8px;
    padding: 6px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    cursor: pointer;
    color: #ccc;
    opacity: 0; /* 初始隐藏 */
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  @media (hover: none) {
  .copy-btn {
    opacity: 1; /* 直接默认显示 */
    background: rgba(255, 255, 255, 0.1); /* 移动端可以调浅一点，避免遮挡代码 */
  }
}

  /* 2. 鼠标悬停在 pre 上时显示按钮 */
  pre:hover .copy-btn {
    opacity: 1;
  }

  .copy-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
  }

  /* 3. 图标切换逻辑 */
  .copy-btn .icon-check { display: none; }
  .copy-btn.copied .icon-copy { display: none; }
  .copy-btn.copied .icon-check { display: block; }
</style>

<script>
  const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
  const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

  function createCopyButtons() {
    // 寻找所有 pre 标签
    const blocks = document.querySelectorAll("pre");

    blocks.forEach((block) => {
      // 防止重复添加（针对 Astro 的 ViewTransitions）
      if (block.querySelector(".copy-btn")) return;

      const button = document.createElement("button");
      button.className = "copy-btn";
      button.innerHTML = `<span class="icon-copy">${copyIcon}</span><span class="icon-check">${checkIcon}</span>`;
      
      block.appendChild(button);

      button.addEventListener("click", async () => {
        const code = block.querySelector("code");
        const text = code ? code.innerText : block.innerText;

        await navigator.clipboard.writeText(text);

        button.classList.add("copied");
        setTimeout(() => button.classList.remove("copied"), 2000);
      });
    });
  }

  // 初始化执行
  createCopyButtons();
  // 如果使用了 ViewTransitions，监听页面跳转事件
  document.addEventListener("astro:page-load", createCopyButtons);
</script>